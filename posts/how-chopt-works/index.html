<!DOCTYPE html><html lang="en-GB" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="How CHOpt works" /><meta property="og:locale" content="en_GB" /><meta name="description" content="When I made this blog I envisioned myself talking about how other people’s programs work. However, I’ve had plenty of people ask me how my own program CHOpt works, so today I’m going to talk about that." /><meta property="og:description" content="When I made this blog I envisioned myself talking about how other people’s programs work. However, I’ve had plenty of people ask me how my own program CHOpt works, so today I’m going to talk about that." /><link rel="canonical" href="/posts/how-chopt-works/" /><meta property="og:url" content="/posts/how-chopt-works/" /><meta property="og:site_name" content="GMS Ruins Video Games" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-06-06T19:26:00+01:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="How CHOpt works" /><meta name="twitter:site" content="@GMS_CH" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-06-06T19:26:00+01:00","datePublished":"2022-06-06T19:26:00+01:00","description":"When I made this blog I envisioned myself talking about how other people’s programs work. However, I’ve had plenty of people ask me how my own program CHOpt works, so today I’m going to talk about that.","headline":"How CHOpt works","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/how-chopt-works/"},"url":"/posts/how-chopt-works/"}</script><title>How CHOpt works | GMS Ruins Video Games</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="GMS Ruins Video Games"><meta name="application-name" content="GMS Ruins Video Games"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/avatar.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">GMS Ruins Video Games</a></div><div class="site-subtitle font-italic">Wherein I spend too much time with games</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/GenericMadScientist" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/GMS_CH" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['rayw1710','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>How CHOpt works</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>How CHOpt works</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1654539960" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Jun 6, 2022 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://github.com/GenericMadScientist">GenericMadScientist</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="4467 words"> <em>24 min</em> read</span></div></div></div><div class="post-content"><p>When I made this blog I envisioned myself talking about how other people’s programs work. However, I’ve had plenty of people ask me how my own program <a href="https://github.com/GenericMadScientist/CHOpt">CHOpt</a> works, so today I’m going to talk about that.</p><p>As a quick note, I’m not going to go over my specific classes and functions because that would be boring and then I’d potentially have to update this. Instead I will go over the algorithm in broad strokes, pointing out some complications that have to be dealt with. Lastly, I will only be discussing guitar: drums has some details that I do not consider to be stable as of writing, and at any rate once you understand the core algorithm it’s not hard to tweak it for drums. The same remark applies to precision mode.</p><h2 id="overview"><span class="mr-2">Overview</span><a href="#overview" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p><a href="https://clonehero.net/">Clone Hero</a> is a Guitar Hero clone first released in 2017. I’m going to assume you’ve played it before; while I’ll go over the key facts about the engine shortly, I’m not going to introduce the core gameplay modes and mechanics.</p><p>However, one mechanic I will single out is Star Power. Star Power (henceforth abbreviated as SP) is accumulated over the course of the song and can be deployed once you have a sufficient amount. For its duration, the amount of points gained is doubled. This means that if you want to get the best possible score, you will have to activate SP at specific times. A plan to activate SP at specific times is called a path. CHOpt’s purpose is to find the optimal path for a given song.</p><h2 id="review-of-clone-heros-engine"><span class="mr-2">Review of Clone Hero’s engine</span><a href="#review-of-clone-heros-engine" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>The details of how SP works is somewhat uncommon knowledge, so here’s what you’d need to know to implement CHOpt. The player has a bar or tank of SP. If the bar is at least half-full, you can activate at will. Surplus SP above a full bar is discarded. Once activated, SP will remain active as the bar depletes, all the way until the bar is empty at which point SP ends.</p><p>SP is acquired from so-called SP phrases. A phrase is a sequence of star-shaped notes. Provided the full sequence is comboed, upon hitting the last note of it one quarter of the bar will be filled. Any sustain notes in the phrase can be whammied for additional SP. Such sustains are called SP sustains. Whammying is binary: as far as the game concerns, you are either whammying or you are not. Whammying more vigorously does not award additional SP.</p><p>The amount of SP gained while whammying is down to how long you have been whammying. But time is not measured here in seconds, it is measured in quarter notes. For most songs this is equivalent to a beat, but not always. For example, if a song is in 7/8 time and you whammy for a measure, you get the whammy for 3.5 quarter notes rather than 7. SP gained from whammying is gained continuously, so you can start and stop whammying mid-sustain if the path calls for it. One quarter note of whammy fills 1/30th of the bar. Therefore, if you want to be able to activate after getting one phrase, that phrase must have at least 7.5 quarter notes of whammy.</p><p>Unlike whammy, SP duration is a function of time in measures. A full bar of SP lasts 8 measures, a half bar lasts 4 measures, and so on. An activation can be extended by hitting additional SP phrases and whammying SP sustains while SP is active. This provides an illustration of the distinction between how SP from whammying is awarded and SP duration. If you have a long SP sustain in 4/4 time, SP is active, and you are whammying, you will slowly gain SP at the rate of 1/120th of the bar per measure. If instead the time signature is 6/4, you will gain SP at the rate of 3/40ths of the bar per measure. Contrast this with when the time signature is 3/4 or 6/8, where you will lose SP at the rate of 1/15th of the bar per measure.</p><p>The other key ingredient is squeezing. In Clone Hero, you can hit notes up to 70ms early or up to 70ms late.<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup> This can be abused to get even more notes under SP, by being able to activate later while still getting the first note under SP and being able to squeeze in an extra note (possibly more) at the end. There are other rare circumstances where squeezing is useful in less obvious ways. The primary one is reverse squeezing. In that situation, you want to activate as soon as possible to not get the last note of a subsequent SP phrase under SP so it can be utilised for a later activation rather than prolonging the current one. You can buy yourself some more room by hitting the last note of the prior SP phrase early to activate even earlier, and hitting the last note of the subsequent phrase late. Sometimes this additional room is critical for making a path possible.</p><p>Abusing the timing window combines with SP sustains to give rise to early whammy. This is where you hit SP sustains early so you can start getting SP from whammy sooner. Clone Hero does nothing to disable SP accumulation from whammy before the note’s time, nor does it affect when the sustain ends. Thus this grants you more SP. For many songs, good early whammy is the biggest component of a good FC score from a path.</p><p>Lastly some words on sustains. Sustains continuously grant you points for their duration. Roughly speaking<sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote" rel="footnote">2</a></sup>, you get one point per 1/25th of a quarter note<sup id="fnref:3" role="doc-noteref"><a href="#fn:3" class="footnote" rel="footnote">3</a></sup>, which is then multiplied by your current multiplier. So if you have a 4x multiplier, your score will go up in 4s during a sustain. Each such increment is called a tick.<sup id="fnref:4" role="doc-noteref"><a href="#fn:4" class="footnote" rel="footnote">4</a></sup> Changing multiplier (like due to activating SP) between ticks does not break up their atomic nature: you would go from +4s to +8s. The time you get the tick isn’t affected by hitting the note early or late, unless the tick is close to the note and you hit the note later than the tick. In that case, all ‘overdue’ ticks are collected the moment you hit the note. It’s also important to know that the last ticks of a sustain are grouped together approximately a quarter of a quarter note before the end of the sustain. So holding a sustain for the maximum amount of time is only crucial for getting maximum SP from SP sustains.</p><h2 id="an-example-song"><span class="mr-2">An example song</span><a href="#an-example-song" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Rather than describe the algorithm in the abstract, let’s look at a simple example chart I made. To keep things simple, this song has no squeezing and no whammy, and is just complicated enough to allow us to focus on the core principles. We’ll start by coming up with an inefficient way of working out the path, then refine it.</p><p><img data-src="/assets/img/ch-example-song.png" alt="Example chart" data-proofer-ignore></p><p>Green regions are SP phrases. The 32 notes at the start are just to make sure we get to 4x before the first SP phrase, meaning we can ignore multipliers.</p><p>We shall start with a relatively straightforward recursive algorithm, starting from the beginning of the song. The earliest activation we can do takes us from the green in m3 to the yellow in m6. This activation gives us 3000 points. Then, the soonest second activation we can do after that goes from the yellow in m22 to the green in m28 (this is possible because we can reverse squeeze). This activation gives us 4400 points, so in total the path gives us 7400 points. If we did this path, then adding on the no SP FC score of 19150 would give us a total score of 26550. However, for every path the no SP FC score is going to be the same so there’s no reason to add it on until the very end when we give the user the estimated score.</p><p>Now obviously in general activating the instant we can is not going to be optimal. So this is where the recursion comes in. Let’s say we do the same first act. We’ll try the next possible second act, which in this case is the yellow in m22 to the red in m28. This grants 4600, so in total the path gives 7600 points. A sure improvement. Then we try the next second activation, yellow in m22 to the yellow in m28. This gives 4800, so a better path still. We cannot go from the yellow in m22 to the blue in m28, so now we move the beginning up a note.</p><p>Our next act would therefore be from the blue in m22 to the red in m28. Now we could calculate this, but you might have realised we don’t need to. See, we already did m22 yellow to m28 red, which is going to be strictly better since we’re starting on an earlier note and ending on the same note. Similarly we can rule out going from the m22 blue to the m28 yellow, and go straight to the act that goes from the m22 blue to the m28 blue. Calculating this gives us 4800 so just as good as our previous best path. Carrying along with this procedure, we go all the way to the end and discover that with our given first activation, the best second activation is from the green in m23 to the chord in m29. This gives 5000, so we now have a path that gives us 8000 points.</p><p>Now we go back and look at the first act again. We were starting with m3 green to m6 yellow. The next possible first act is m3 green to m7 green. This gives us 3200. Then we redo the step we did with the second activation to find the best matching second activation. Again, this turns out to be m23 green to m29 chord, which is 5000, so this path gives us 8200 points.</p><p>For our third potential first act, we do m3 red to m7 red… right? Except this isn’t possible, for the m7 red is the last note of a phrase and so extends our activation. Therefore, the true next activation we need to consider is m3 red to m9 green, which awards 4600 points. Then we have to find the best second activation that fits this. This search starts with m24 yellow to m28 red and ends with m25 green to m29 chord. It turns out the best of these is m25 green to m29 chord which gives 3600 points. In total this path is worth 8200 points.</p><p>Then we do as first act m3 red to m9 red, and so on. Eventually this algorithm leads us to the finished product, our optimal path.</p><p><img data-src="/assets/img/ch-example-path.png" alt="Example path" data-proofer-ignore> <em>Activations are denoted with blue</em></p><h2 id="but-why-repeat-yourself"><span class="mr-2">But why repeat yourself?</span><a href="#but-why-repeat-yourself" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>We have in our hands a basic algorithm that gets the job done, although it’s very inefficient. The next step is to make it respectable.</p><p>Notice that with the first two possibilities for the first activation, we got the same answer for the rest of the path. This is because both of those activations ended before the same phrase. Therefore whatever the best continuation of the path will be for one of them, it’ll be the same for the other. This observation is incredibly powerful and lets us dramatically improve our algorithm.</p><p>Once we’ve added an activation to the path, we count how many SP phrases are left in the song. If we’ve not already ended up in this situation, we diligently work out the optimal way to use that number of SP phrases. We then, crucially, store this information in some data structure of choice. If we have been in this situation before, though, then we know the answer and have it saved already. So we just retrieve the answer and append it to the end of the path.</p><p>This is a classic example of <a href="https://en.wikipedia.org/wiki/Dynamic_programming">dynamic programming</a> since we are using the solution to subproblems in order to solve our overall problem. The speedup is as dramatic as one typically gets from such insights. Done correctly, this is enough to get a usable optimiser.</p><p>To illustrate how effective this is, here is a sketch of what happens when we apply this to our example chart. Our initial first activation is m3 green to m6 yellow. Exactly as we did initially, we work out that the best way to use the remaining SP is to go from m23 green to m29 chord. This is the best way to use three remaining phrases. In total this path gives 8000 points.</p><p>Then we start with m3 green to m7 green, which also has three remaining phrases. So we use the answer to this subproblem we have, and now we have a path that gives 8200 points. Then we do m3 red to m9 green. Now we have two phrases left, and work out that these are best used to do m25 green to m29 chord. In total this path is also worth 8200 points. Next we do m3 red to m9 red, and are left with two again. Tacking that on, we get 8400 points. We keep going until we try m8 green to m14 chord, which combined with the last two phrases gives 8800 points.</p><p>Once we go forward a bit more, we end up not finding anything better before we start overlapping more phrases. Now we will end up with one or zero phrases left, not enough to give us an extra activation so the only thing we can do with them is nothing. Carrying on until we’re done with the song, we find the optimal path is the 8800 points one mentioned already and shown above.</p><p>One feature of this technique not apparent with this example comes into play once we have more than two activations. For we don’t just use this optimisation to handle the last activation. We can use it for the rest of the path, and even when working out the rest of the path for the first time, we end up accumulating lots of information to speed up even that process.</p><p>Another way you could make use of this insight is to work backwards. Start with the best way to use the last phrase: do nothing. Then go back and work out the best way to use the last two phrases. Then the last three, and so on, back and back until we’ve got to the start.</p><p>However, CHOpt goes with the recursion and <a href="https://en.wikipedia.org/wiki/Memoization">memoisation</a> approach for two main reasons. The first is that not all subproblems end up coming up. In our example, calculating the optimal way to use the last four phrases would be a waste of time since we can never arrive this situation. This point becomes stronger once we consider the effect of SP sustains, which I will discuss in a moment. The other reason is because it would complicate the second significant optimisation, which I will get to in a while.</p><h2 id="why-its-not-so-simple"><span class="mr-2">Why it’s not so simple</span><a href="#why-its-not-so-simple" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>In our example, we were able to get by with only counting the number of remaining phrases. But obtaining a full phrase is only one way to acquire SP. We can also get SP by whammying SP sustains. This immediately raises a problem: what if an activation ends in the middle of a phrase and covers some but not all of the constituent SP sustains?</p><p><img data-src="/assets/img/ch-mid-phrase.png" alt="Complication example" data-proofer-ignore> <em>An activation ending mid-phrase</em></p><p>It is clear that merely counting the number of remaining phrases is far too crude. Perhaps we can only apply the optimisation in the case the activation ends before the next phrase starts? This would work provided we require the activation end at least 70ms before the next phrase starts, so we have the full amount of early whammy available. But this retreat gives up too much: activations ending mid-phrase are very common in optimal paths, and the vast majority of songs have the potential for them. And so long as the potential is there, we have to contend with it, even if in the end it may not turn out to be part of the optimal path. One could tweak this so our rule is that the act ends at least 70ms before the first SP sustain in the phrase, but this would be of only marginal assistance.</p><p>No, instead we must work out how to accommodate this properly. Think back to saving the subpaths. A natural way to view the structure used for this is a dictionary. The key is the number of remaining phrases, the value is the optimal way to utilise them.<sup id="fnref:5" role="doc-noteref"><a href="#fn:5" class="footnote" rel="footnote">5</a></sup> The problem is with our key, and that way lies the solution. We refine the key by making it a tuple of both the number of remaining phrases, and the number of remaining quarter notes of SP sustain left in the song. More simply, we can store this information as a position, taking the position the act ended and then moving it forward to 70ms before the next phrase if we are not already mid-phrase.<sup id="fnref:6" role="doc-noteref"><a href="#fn:6" class="footnote" rel="footnote">6</a></sup></p><p>Actually, it turns out to be better to use as key a tuple of position and the first point not under the act (moving this point forward like the position in a similar way). The main issue with just using a position is it adds a complication when SP runs out just after the last note of an SP phrase, and we hit said note late to not overlap. Using the position alone we would have to add in an auxiliary calculation that we are not far enough ahead to have hit the SP, and this is messy (messy and not even correct<sup id="fnref:7" role="doc-noteref"><a href="#fn:7" class="footnote" rel="footnote">7</a></sup>). The majority of the time, this has the same effect as just using position so the extra strictness of our key does not cost us dearly in performance.</p><h2 id="the-second-optimisation"><span class="mr-2">The second optimisation</span><a href="#the-second-optimisation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>With this optimisation done well, and taking some time with a profiler to find out what you’ve done poorly, you can get very far. Indeed, for a good while this is the position CHOpt was in. But then it starts getting viable to throw full albums at your optimiser, and while they generally do get handled, they take a while. Wouldn’t it be nice to have an idea that helps with these dramatically, while also helping with more typical charts?</p><p>Let’s think a little about what happens when we throw in a long chart. We’ll revert to our earlier version where we only counted the number of remaining phrases, a song with no squeezes or SP sustains. Let’s also assume our SP phrases are distributed roughly evenly, as is typical. Let \(N\) denote the length of our song (the specific units deliberately left vague) and \(k\) the number of SP phrases.</p><p>We will almost definitely have to work out what to do with the last two phrases. This entails, at a minimum, working out what to do starting with every point after the last phrase. This will take time roughly proportional to \({N/(k + 1)}\).</p><p>For the last three phrases, we will have to consider an activation starting with every point after the second last phrase, taking time roughly proportional to \({2N/(k + 1)}\). Similarly we go back and back to considering all but the first phrase (and we are likely to need to consider all these subproblems), giving us the sum</p><p>\[ ((k - 1) + (k - 2) + \cdots + 1)N/(k + 1) \]</p><p>This comes out to \(O(kN)\). For typical charts the number of SP phrases is roughly proportional to \(N\), so at a bare minimum we’re talking \(O(N^2)\). What can we do?</p><p>It turns out that in the process of doing this we will be repeating ourselves. Say our song has 100 phrases, and we want to work out what to do with the last 30 and the last 50 phrases. Once we are up to the last 26 phrases, in both cases we already have a full bar. From then on, the rest will be exactly the same. And so we have another opportunity for memoisation.</p><p>The trick is, when doing this process, track once you have acquired four SP phrases. At this point your bar is already full, and at that position it doesn’t make a difference if you have already collected four phrases or nine. So once we’re up to this point, from then on we find the best way to finish the path. We then store this in a data structure reserved for telling us the best way to finish the path if we are up to a certain position and we must already have a full bar. Then, in our 100 phrase song, when we start with the last 50 phrases we are likely done once we’ve collected five phrases, for then we can probably rely on the result we got up to this point when calculating the result for the last 49 phrases.</p><p>If you run through the back-of-the-envelope calculation above with this new optimisation, you get \(O(N)\). Since this is a lower bound, this is not to say CHOpt itself is linear: in fact that is definitely not the case because it does sorts and many \({O(\log N)}\) operations. But the calculation conveys quite well the savings on offer.</p><h2 id="looking-ahead"><span class="mr-2">Looking ahead</span><a href="#looking-ahead" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>After spending the time to make CHOpt nice and speedy, it’s tempting to try and make it even faster. But is there much point?</p><p>For typical songs, CHOpt now finds the optimal path so quickly that the majority of the time is spent in libpng saving the image. Making the process of finding the optimal path 50% faster would barely matter, and besides, it’s fast enough that for most charts users barely have to wait at all. While the image saving bottleneck might potentially be addressed by saving as SVG, PNG files are just far more convenient and it starts to feel silly at that level.</p><p>One major problem is exhibited by NFL on Fox Theme from <a href="https://customsongscentral.com/carpal-tunnel-hero-3/">Carpal Tunnel Hero 3</a>. It’s a mostly slow ha ha funny meme chart that ends with an insanely high BPM SP sustain and CHOpt’s major optimisations don’t help here. To a human, the optimal path is easy to see. You can remove the big sustain and the path you get would overlap the start of it anyway, so the optimal path is to do that then just keep whammying until the song ends. It’s less clear how to devise a general way to spot this without some horrible hard-coding.</p><p>I think the way to go is to look again at the second optimisation and improve it. It doesn’t apply here because we just have the one phrase, and we can’t just change it to being able to get a full bar because on some songs it’s optimal to not always whammy SP sustains. But I feel it should be possible to tweak it by dividing into five, according to having zero, one, two, three, or at least four phrases, and in all such cases being able to full bar if desired. This should bring NFL on Fox Theme under control; well in a theoretical sense anyway. It’s obvious what the optimal path is, and the sustain is so long that the image file is too big to work.</p><p>Long SP sustains have been a thorn in CHOpt’s side before. Back when I made the original version, Sweating Bullets from Guitar Hero 5 was a big pain. Then I got it under control, and things were mostly fine until encountering Time Traveler from <a href="https://customsongscentral.com/circuit-breaker/">Circuit Breaker</a>.</p><p><img data-src="/assets/img/ch-time-traveler.png" alt="Time Traveler SP" data-proofer-ignore> <em>This happens twice, by the way</em></p><p>That aside, it would be nice to add support for other games and engines. CHOpt has support for Rock Band 3 guitar, and Clone Hero drums before it got changed again. I’m especially interested in the older Guitar Hero games and Warriors of Rock (including power-ups). While there are many differences between these engines, I am confident the core algorithm with these optimisations is robust enough to accommodate them.</p><p>Something else I’d like to do at some point is allow CHOpt to find paths that involve missing or overstrumming, when that’s optimal. Incredibly rare, but I am aware of one example in Clone Hero where this is the case with a chart not made specifically to exhibit this behaviour. This would require a slight change to the algorithm, where the key for the dictionary would have to also include the combo. Because the combo can be capped once the multiplier reaches 4x, this shouldn’t be as bad as it might sound.</p><div class="footnotes" role="doc-endnotes"><ol><li id="fn:1" role="doc-endnote"><p>On guitar, with no modifiers on. There is a wrinkle here: you can strum notes even earlier than 70ms without overstrumming or missing, and the game will register the note once the note is 70ms ahead. Matt, the lead developer of Clone Hero, has told me this leniency window is 50ms. This is useful knowledge for executing paths but does not affect whether the note can be hit under SP, so for the purpose of implementing CHOpt it is irrelevant. <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p><li id="fn:2" role="doc-endnote"><p>Due to a bug that cannot be fixed for backwards compatibility, the exact spacing between ticks depends on the resolution of the chart or midi. I shall not go into the details here, suffice to say that for your typical .chart chart it’s closer to 27.4 ticks per quarter note, and for your typical .mid chart it’s around 25.3 ticks per quarter note. <a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p><li id="fn:3" role="doc-endnote"><p>I am ignoring extended sustains, but that makes no essential difference in what follows. <a href="#fnref:3" class="reversefootnote" role="doc-backlink">&#8617;</a></p><li id="fn:4" role="doc-endnote"><p>Ticks aren’t a concept in Clone Hero’s code, the behaviour is entirely a consequence of rounding. However, they’re an invaluable fiction and since they perfectly reproduce the game’s behaviour, the little lie is harmless. <a href="#fnref:4" class="reversefootnote" role="doc-backlink">&#8617;</a></p><li id="fn:5" role="doc-endnote"><p>One should also store the number of points granted to save having to recalculate it, but this is besides the point. <a href="#fnref:5" class="reversefootnote" role="doc-backlink">&#8617;</a></p><li id="fn:6" role="doc-endnote"><p>I am glossing over some details of the calculation of the right position for the sake of clarity, but when implementing this these details become clear. There is further room for some tweaks here, but I do not feel them important or interesting enough to warrant discussion here. <a href="#fnref:6" class="reversefootnote" role="doc-backlink">&#8617;</a></p><li id="fn:7" role="doc-endnote"><p>If the BPM is insanely high, the position need not tell us the number of remaining phrases. For instance, with a BPM of 13714 we get that four 4/4 measures take up just under 70ms. In general a very high BPM can give rise to lots of thorny problems due to breaking reasonable assumptions about the order of the times events can happen. I have not focused on them too much since they are so artificial, so if someone wanted to find mistakes in CHOpt this would be an excellent area to focus on. <a href="#fnref:7" class="reversefootnote" role="doc-backlink">&#8617;</a></p></ol></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/clone-hero/'>Clone Hero</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=How+CHOpt+works+-+GMS+Ruins+Video+Games&url=%2Fposts%2Fhow-chopt-works%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=How+CHOpt+works+-+GMS+Ruins+Video+Games&u=%2Fposts%2Fhow-chopt-works%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=How+CHOpt+works+-+GMS+Ruins+Video+Games&url=%2Fposts%2Fhow-chopt-works%2F" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/ps2-ai-teams/"><div class="card-body"> <em class="small" data-ts="1643037540" data-df="ll" > Jan 24, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>How Pokémon Stadium 2 utterly fouls up team selection</h3><div class="text-muted small"><p> Alternative title: how to be passive aggressive with asterisks. Overview In Pokémon Stadium 2 the vast majority of battles have you and your opponent bring a team of six. From there, both sides c...</p></div></div></a></div><div class="card"> <a href="/posts/challenge-cup/"><div class="card-body"> <em class="small" data-ts="1641731670" data-df="ll" > Jan 9, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Challenge Cup teams in Pokémon Stadium 2</h3><div class="text-muted small"><p> It’s been a while, hasn’t it? I did have plans for having my next post be on Dragon Ball Z: Budokai Tenkaichi 2, but then I decided that to do that as well as I wanted I would first have to do one ...</p></div></div></a></div><div class="card"> <a href="/posts/ntr-friendship/"><div class="card-body"> <em class="small" data-ts="1626715922" data-df="ll" > Jul 19, 2021 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Friends in Yu-Gi-Oh! Nightmare Troubadour</h3><div class="text-muted small"><p> This is the third and final post I plan to do on Yu-Gi-Oh! Nightmare Troubadour. I may come back to it at a later date, but for now I’ve worked out everything I really wanted to know. Like the prev...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/ps2-ai-teams/" class="btn btn-outline-primary" prompt="Older"><p>How Pokémon Stadium 2 utterly fouls up team selection</p></a><div class="btn btn-outline-primary disabled" prompt="Newer"><p>-</p></div></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://github.com/GenericMadScientist">GenericMadScientist</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script> /* see: <https://docs.mathjax.org/en/latest/options/input/tex.html#tex-options> */ MathJax = { tex: { inlineMath: [ /* start/end delimiter pairs for in-line math */ ['$', '$'], ['\\(', '\\)'] ], displayMath: [ /* start/end delimiter pairs for display math */ ['$$', '$$'], ['\\[', '\\]'] ] } }; </script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"> </script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script data-goatcounter="https://gmsblog.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
