<!DOCTYPE html><html lang="en-GB" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="How Pokémon Stadium 2 utterly fouls up team selection" /><meta property="og:locale" content="en_GB" /><meta name="description" content="Alternative title: how to be passive aggressive with asterisks." /><meta property="og:description" content="Alternative title: how to be passive aggressive with asterisks." /><link rel="canonical" href="/posts/ps2-ai-teams/" /><meta property="og:url" content="/posts/ps2-ai-teams/" /><meta property="og:site_name" content="GMS Ruins Video Games" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-01-24T15:19:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="How Pokémon Stadium 2 utterly fouls up team selection" /><meta name="twitter:site" content="@GMS_CH" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-01-24T15:19:00+00:00","datePublished":"2022-01-24T15:19:00+00:00","description":"Alternative title: how to be passive aggressive with asterisks.","headline":"How Pokémon Stadium 2 utterly fouls up team selection","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/ps2-ai-teams/"},"url":"/posts/ps2-ai-teams/"}</script><title>How Pokémon Stadium 2 utterly fouls up team selection | GMS Ruins Video Games</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="GMS Ruins Video Games"><meta name="application-name" content="GMS Ruins Video Games"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/avatar.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">GMS Ruins Video Games</a></div><div class="site-subtitle font-italic">Wherein I spend too much time with games</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/GenericMadScientist" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/GMS_CH" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['rayw1710','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>How Pokémon Stadium 2 utterly fouls up team selection</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>How Pokémon Stadium 2 utterly fouls up team selection</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1643037540" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Jan 24, 2022 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://github.com/GenericMadScientist">GenericMadScientist</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="3793 words"> <em>21 min</em> read</span></div></div></div><div class="post-content"><p>Alternative title: how to be passive aggressive with asterisks.</p><h2 id="overview"><span class="mr-2">Overview</span><a href="#overview" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>In Pokémon Stadium 2 the vast majority of battles have you and your opponent bring a team of six. From there, both sides choose a subset of three to bring. This post is on how the game decides which subset of three to bring and my descent into madness brought about by trying to understand the implications of all the mistakes the programmers made. To check my understanding of this and to provide a helpful tool for determining the effect of the player’s choice of rentals on the teams the AI brings, I’ve made <a href="https://genericmadscientist.github.io/AI-Team-Manipulator">something</a> you can play with. To understand what exactly is going on and get some intuition for it, read on.</p><h2 id="what-they-tried-to-do"><span class="mr-2">What they tried to do</span><a href="#what-they-tried-to-do" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>It’s easiest to start with what the likely intended algorithm was. This is purely to give a rough picture and provide a structure for all the details. Do not take everything in this section as gospel: some of it is just flat-out wrong. I will put an asterisk beside anything that is wrong on some level.</p><p>The two Rival fights are of a different format than any other important fight in the game so to make the rest of this post easier to word I’ll just state now how he behaves. He always brings all three of his Pokémon, in Round 1 his lead is random with an equal probability for each, and in Round 2 he always leads Lugia.</p><p>First the game assigns a fitness value to each of its six Pokémon. Some trainers do this by picking six independent* random values from 0 to 65535 inclusive. The majority do this by instead looking at each of your six Pokémon, computing a matchup fitness unaffected by the rest of your team* and then summing the six obtained values. Each matchup fitness is based off the worst-case amount of damage you can do with the moves your Pokémon can learn*, the damage they can do to you with each of their moves, and some bonuses for status and other things their moves can do. All of these are weighted with values specific to the opponent in question*.</p><p>Next the game looks over all 20 possible teams of three. It is worth noting that the order of the members of each trio are just the order they appear in the team of six. If the mode is Poké Cup, the game first rules out any team with a total level above 155. For specific trainers it will then rule out any teams that do not contain the first Pokémon of the six. For some others it will rule out those that do not contain the last. A few trainers, like Round 1 Erika, must bring both.</p><p>Some trainers are not allowed to bring both of their Pokémon with the highest fitness values. For determining what the best two are, earlier Pokémon take precedence in case of a tie. The game then randomly selects one of them to forbid, rather than only filtering off teams containing both. Some trainers must also bring a Pokémon from each column. As a fun aside, Round 1 Min &amp; Lyn have this condition but must also bring Ledyba which locks them out of bringing Hoppip.</p><p><img data-src="/assets/img/ps2-min-and-lyn.png" alt="Min &amp; Lyn's team" data-proofer-ignore> <em>How the Pokémon are ordered, and what is meant by columns</em></p><p>For each remaining valid trio, the game assigns a team fitness. To do this, it simply sums the individual members’ fitness values and then applies multipliers for weaknesses shared by multiple team members*. Then the game determines the best eight teams according to their team fitness values (randomly choosing which to keep in the event of a tie). Some opponents are more restrictive though, and only take the best four teams. Out of these trios the game then selects one, assigning an equal probability* to them all.</p><p>With the team selected the last thing the game must do is choose the lead. Some opponents just pick a random lead out of the three. Some opponents always go with the first member of the trio. For the others, the game assigns to each member of the trio a lead fitness. This starts out at 0 for each member. 20 is added for the Pokémon with the highest speed (ties broken randomly) and 30 is either added or subtracted for the Pokémon with the highest fitness (ties broken randomly) depending on whether the opponent has a preference for leading with the highest fitness Pokémon or keeping it in back. A final bonus is added for any Pokémon that has Baton Pass, the size of which depends on the opponent. With the lead fitness values assigned, the game picks the Pokémon with the highest lead fitness (again, breaking ties randomly) and swaps it with the first Pokémon of the trio.</p><p>Needless to say all random decisions and values come from a PRNG that is very good* and is initialised very well* and there are no significant and easily noticeable restrictions or biases that result from this*.</p><h2 id="ai-values"><span class="mr-2">AI values</span><a href="#ai-values" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>As mentioned above certain opponents have specific behaviour for which teams they allow and a bunch of weights giving how much they care about Baton Pass on leads, the damage you can do to them, and so on. So before going deep into the details of the calculations, <a href="/assets/data/ps2-ai-data.csv">here</a> is that data.</p><h2 id="individual-fitness-values"><span class="mr-2">Individual fitness values</span><a href="#individual-fitness-values" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>The calculation of the individual fitness values is easily the most involved step in the entire process and they are the means by which the player’s team can influence the AI’s team selection. As mentioned above some opponents just assign random fitness values which gives them a fixed probability distribution for team selection regardless of the player’s team. For the rest though, there are a number of steps (and mistakes…). The game computes six values for the matchups of its Pokémon against each of your six Pokémon and then adds these together. These values are generally independent but a few bugs mean in theory there can occasionally be an interaction.</p><h3 id="step-1-damage-you-can-do"><span class="mr-2">Step 1: damage you can do</span><a href="#step-1-damage-you-can-do" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Most opponents don’t read your moves for team selection and consider all moves your Pokémon could know at that level. Some do though, in which case they just go over your moves. First though, note for this step the following moves are ignored: Absorb, Beat Up, Bide, Dream Eater, Explosion, Fissure, Future Sight, Giga Drain, Guillotine, Horn Drill, Hyper Beam, Leech Life, Mega Drain, Razor Wind, Selfdestruct, and Skull Bash. Moves with a power of 0 are also ignored. Moves that directly do damage like set damage moves are assigned a base power of 1 to get around this, except for Guillotine which is assigned a base power of 0.</p><p>For moves not filtered out by the above, the game calculates how much damage the move would do against its Pokémon. Moves with variable power are treated as having the following power:</p><ul><li>Flail and Reversal: 60<li>Return and Frustration: the correct power for the friendship value<li>Present: 52<li>Magnitude: 64<li>Hidden Power: 1, and treated as normal type.</ul><p>The OHKO moves (skipped due to the above, but will be important later) are treated as doing 65535 damage, except for Guillotine which is counted as doing 0 damage. Super Fang, Dragon Rage, SonicBoom, Night Shade, and Seismic Toss are treated as doing the correct amount of damage. Psywave is treated as doing damage equal to 0.75 * the user’s level. For other moves the standard damage formula applies, including the effects of Light Ball, Thick Club, and items that boost moves of a specific type like Pink Bow and TwistedSpoon. However, the random factor applied at the end of damage calculation is skipped and a max damage roll is assumed. Additionally, some opponents skip applying the effect of STAB and resistances/weaknesses.</p><p>The maximum damage from these moves is then divided by the HP of the AI’s Pokémon and scaled to lie between 0 and 255 inclusive (capping out at 255).</p><p>Lastly some notes on how the AI determines if your Pokémon can learn a move. It mostly goes the same as Challenge Cup, except egg moves and learning level-up moves due to breeding only apply to Pokémon at least level 5. Additionally, some special event moves are considered, and these are:</p><ul><li>Fearow and Rapidash: Pay Day, minimum level 1<li>Pikachu and Raichu: Fly and Surf, minimum level 1<li>Psyduck and Golduck: Amnesia, minimum level 1<li>Farfetch’d: Baton Pass, minimum level 5<li>Magikarp: Dragon Rage, minimum level 1<li>Dratini: ExtremeSpeed, minimum level 15<li>Gligar: Earthquake, minimum level 5</ul><p>These also apply to evolutions in the same way as explained in the <a href="/posts/challenge-cup/">Challenge Cup post</a> for typical moves.</p><p>Oh, and there is one incredibly stupid bug worth mentioning, especially since as of writing I haven’t implemented it. The problem is when checking if your Pokémon learns a move it fails to properly initialise the level. Now once it’s gone into damage calculation for the first move, the level gets set correctly for the rest of the computation of that matchup’s value. This is part of what stops it being too damaging.</p><p>The other saving grace is that the game iterates over the moves in reverse order. The last move is Beat Up, which is skipped anyway. The next two are Whirlpool and Rock Smash, and more than half of Pokémon learn at least one of these via HM which solves the problem for them. Hidden Power is a late move and a universal TM which also puts a cap on things quickly. In total, the moves that can be potentially missed that have an opportunity of being the best move are:</p><ul><li>Caterpie and Metapod: Tackle<li>Weedle and Kakuna: Poison Sting<li>Ekans and Arbok: Crunch<li>Exeggcute and Exeggutor: AncientPower (often tied by Double-Edge, but not always)<li>Magikarp: Dragon Rage and Flail<li>Unown: Hidden Power (remember it’s counted as Normal BP 1)<li>Wobbuffet: Counter and Mirror Coat (remember they’re counted as BP 1)<li>Larvitar and Pupitar: Crunch</ul><p>Worth noting that an uninitialised level might potentially have the opposite effect: a Pokémon potentially being seen as learning one of these moves when it shouldn’t be able to. In that connection should also be mentioned AncientPower for Larvitar and Pupitar: any one that can learn AncientPower can also learn Rock Slide, but it is possible for a legal low-level Pupitar from Crystal to not have access to either yet temporarily be thought of as level 30 or higher and so have access to AncientPower.</p><p>It seems that the uninitialised level always starts as zero, regardless of the order of your team. I’ve not done an in-depth investigation of what happens to the value, but I have played around with team order and seen that this doesn’t affect the calculation for Wobbuffet.</p><h3 id="step-2-damage-they-can-do"><span class="mr-2">Step 2: damage they can do</span><a href="#step-2-damage-they-can-do" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>This is similar to the above, except the game works out the above for each of the AI’s moves and keeps them separate rather than just taking the maximum (see step 4). The game also no longer skips moves like Giga Drain and Hyper Beam. For this calculation, Beat Up is treated as a typical Dark move with base power 10.</p><h3 id="step-3-other-things-they-can-do"><span class="mr-2">Step 3: other things they can do</span><a href="#step-3-other-things-they-can-do" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Here the game comes up with a special bonus for each of the AI’s moves. This is based off effects other than damage, and is affected by various weights each AI has. In the following, note that the chance of the secondary effect activating is a number from 0 to 255 rather than the more standard percentages.</p><h4 id="moves-that-cause-status-sleep-poison-burn-freeze-paralysis"><span class="mr-2">Moves that cause status (sleep, poison, burn, freeze, paralysis)</span><a href="#moves-that-cause-status-sleep-poison-burn-freeze-paralysis" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>The value is generally</p><p>(28 * (AI weight for given status) * (chance of secondary effect)) / 255,</p><p>rounded down. However the value is instead zero if the secondary chance cannot happen for type reasons. Tri Attack is ignored for this.</p><h4 id="moves-that-raise-the-ais-stats"><span class="mr-2">Moves that raise the AI’s stats</span><a href="#moves-that-raise-the-ais-stats" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>(2 * (AI weight for raising given stat) * (chance of secondary effect) * (stages raised)) / 255.</p><p>Evasion is considered a stat for this. Attacks that can raise stats are counted as raising by two stages for some reason, except for AncientPower which is counted as one stage but computes the above expression for the five stats it can raise and adds the results. Curse is ignored for this.</p><h4 id="moves-that-lower-the-players-stats"><span class="mr-2">Moves that lower the player’s stats</span><a href="#moves-that-lower-the-players-stats" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>This is an absolute mess. The intent was clearly to do the same as the above but with a bunch of weights for lowering stats. However, whoever coded that function mixed up the order of the arguments for the stat to effect and the chance of a secondary effect, so as a result the game is accessing different memory and multiplying by a number for the stat in question. The multiplier for the stats thus come to:</p><ul><li>Attack: 0<li>Defense: 1<li>Speed: 2<li>Special Attack: 3 (but no moves do this)<li>Special Defense: 4<li>Accuracy: 5<li>Evasion: 6</ul><p>For the effect chance, there are five values and they come to the following:</p><ul><li>10% moves: still falls within the AI data structure and so has an opponent-dependent value<li>20% moves: if this is the first of the AI’s Pokémon, 0. Otherwise the fitness of the first Pokémon divided by 65536, rounded down, and then modulo 256<li>30% moves: if this is one of the first three of the AI’s Pokémon, 0. Otherwise the fitness of the third Pokémon divided by 256, rounded down, and then modulo 256<li>50% moves: 0<li>100% moves: 0</ul><p>It is worth noting that since the game is now multiplying by the stat ID in place of the effect chance, the resulting value will be smaller. Nevertheless, my program takes account of this.</p><h4 id="flinch-moves"><span class="mr-2">Flinch moves</span><a href="#flinch-moves" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>The same type of calculation as for status, except 0 if the attacker’s speed is not greater and type matchup is ignored.</p><h4 id="confusion-moves"><span class="mr-2">Confusion moves</span><a href="#confusion-moves" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>The same type of calculation as for status but type matchup is ignored. Swagger is ignored.</p><h4 id="attract-baton-pass-disable-focus-energy-light-screen-mist-reflect"><span class="mr-2">Attract, Baton Pass, Disable, Focus Energy, Light Screen, Mist, Reflect</span><a href="#attract-baton-pass-disable-focus-energy-light-screen-mist-reflect" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>A fixed opponent-dependent value for each of the six moves in question, except for Attract which is zero if the opponent’s Pokémon cannot infatuate the player’s Pokémon.</p><h3 id="step-4-putting-it-together"><span class="mr-2">Step 4: putting it together</span><a href="#step-4-putting-it-together" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>The matchup’s value starts at zero. For each of the AI Pokémon’s four moves, the game first takes the damage the move can do to the player, as a proportion out of 255. The game then multiplies this by 128, the accuracy for the move (as a value from 0 to 255), the weight the AI assigns to damage it causes, then divides by 255 and rounds down. Then the game takes any bonus for secondary effects calculated in step 3, multiplies by the move’s accuracy and a weight assigned to secondary effects, then again divides by 255 and rounds down. As a third and final term the game takes the amount of damage the player can do as calculated in step 1 and multiplies it by 58 and a weight assigned to damage by the player. An exception to this is if the AI’s move is Selfdestruct or Explosion, in which case the AI instead treats the damage done by the player as maximum for this one part.</p><p>These three terms are then added together and that is added to the value. Note therefore that the term for damage done by the player is typically multiplied by 4 for the final result, excepting the cases of Selfdestruct and Explosion. This is true even if the AI’s Pokémon has less than four moves: for the empty moves slots, the terms for damage and secondary effects caused by the AI are zero but there is still a deduction for damage done by the player.</p><h2 id="penalty-for-resistances-yes-really"><span class="mr-2">Penalty for resistances (yes, really)</span><a href="#penalty-for-resistances-yes-really" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>This calculation is truly amazing because there are three separate errors here. A note before going into it though: some opponents don’t do this part at all.</p><p>The game loops over all attack types. Wait, sorry, that’s not right. Mistake one: the game only loops over physical attack types. This is caused by there being at least two different numbering systems the game uses for types, and there is a mismatch here.</p><p>For each physical attack type, the game counts how many members of the trio <del>are weak to</del> resist that attack type. There’s mistake 2. If the team fitness is positive, the game will multiply the team fitness with 1 - 0.1 * (number of pairs that resist attack type). If the team fitness is negative, the factor will instead be 1 + 0.1 * (number of pairs that resist attack type). Note that the number of pairs will be 0, 1, or 3.</p><p>The last mistake is in the multiplication. The game does not multiply by, say, 1.3 directly. It instead multiplies by 13 and then divides by 10, and similarly for any factor it will multiply by (factor * 10) and then divide by 10. This multiplication can cause an overflow. And this isn’t some nitpicky artificial scenario: this can happen and confused me for a good hour when it came up during testing. Specifically, it comes up in Werster’s <a href="https://www.youtube.com/watch?v=VWrlJWpBEFY&amp;t=23188s">Complete the Game PB</a> against Chen in R1 Poké Cup Great Ball. The team Haunter / Spinarak / Misdreavus should be impossible with that rental team, but the combined resistances factor is 2.4167 and the final multiplication by 13 is enough to cause the team fitness to overflow and become positive.</p><h2 id="how-not-to-do-randomness"><span class="mr-2">How not to do randomness</span><a href="#how-not-to-do-randomness" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>I was initially planning to do a separate post on how Stadium 2’s PRNG is bad, but the problem is so pervasive in team selection that I feel this post would be incomplete without discussing it.</p><p>The short version for people who know about such things is that Stadium 2 uses an <a href="https://en.wikipedia.org/wiki/Linear_congruential_generator">LCG</a> for this that returns all the bits of the seed without reordering them in any way. This is especially pernicious because most of the time the game then takes the result modulo 2 or 8. The cherry on top is that the game initialises this PRNG right before team generation with a value that is the bitwise and of two values that for most practical purposes are independent, horrifically skewing the distribution.</p><p>For the rest of you, I won’t bore you with the maths behind LCGs since it’s not that necessary to get the salient points. The most important consequence of the choice of PRNG is that if the game generates a sequence of numbers that lie between 0 and 7 inclusive, it will go in the following cycle:</p><p>…, 0, 7, 2, 1, 4, 3, 6, 5, 0, 7, 2, 1, 4, 3, 6, 5, …</p><p>This is because 8 is a power of two, and other powers of two have this property. The most common one that comes up here is 2, for when the game needs to decide between one of two options. This goes in a cycle of 0, 1, 0, 1, … and is related to the cycle for 8 by taking the remainder from division by 2.</p><p>The importance of this cyclic behaviour is it creates strange relationships between random choices. The big one is in the choice of lead when the game has two options with equal highest lead fitness. Most of the time the AI has eight teams to pick from, so it picks one, and then the next number on the cycle determines the choice of lead. If there’s a speed or fitness tie that comes up while computing the lead fitness values, this is also related so the constraint is still there.</p><p>It should be noted that if instead of a power of two the number is odd, then the choice is not at all related but the cycle still goes one forward and so there is still a relationship between random numbers before and after. This means that for trainers that just have a random lead, the lead can be treated as independent of what comes before, or close enough. This also comes up for trainers who have less than eight valid teams, often due to the combination of not using both of their highest fitness Pokémon and the Poké Cup level cap. In the case of six teams there’s some relationship: whether the result is odd or even is determined by the position in the cycle, but beyond that it’s fairly independent.</p><p>All of this is pretty constraining but I’ve saved the best for last. See, I’ve not told you how the game determines where on the cycle to start and it makes this decision right before going into team selection. And it does it absolutely terribly. It takes the bitwise and of two independent random values, when the combining operation you want is a bitwise xor. This means the starting value satisfies the following distribution:</p><div class="table-wrapper"><table><thead><tr><th>Starting value<th>Probability<tbody><tr><td>0<td>42.1875%<tr><td>1<td>14.0625%<tr><td>2<td>14.0625%<tr><td>3<td>4.6875%<tr><td>4<td>14.0625%<tr><td>5<td>4.6875%<tr><td>6<td>4.6875%<tr><td>7<td>1.5625%</table></div><p>This is why most opponents will massively favour a given trio (provided we fix the player’s team). In the general case, we’re likely to start with 0. The game then moves one along to determine which of the two best Pokémon to ban (even if the opponent in question doesn’t care about that) generating the value of 7, or really 1. Then assuming there’s no ties in total team fitness and there are at least eight valid teams, it will generate the value of 2 and so pick the third best team. Then if the opponent doesn’t just pick a random lead, the lead is determined by the position on the cycle.</p><p>As a result if you’re trying to make one desired team the common team then you’re typically focusing on which team the game thinks is the third best rather than the best, which is rather counter-intuitive and practically impossible to guess just from playing the game. If the opponent doesn’t bring both of their best Pokémon and you have a specific Pokémon that you really don’t want to see then you really want to steer them towards judging it as their second best Pokémon.</p><p>Finally, the same problem happens with random values from 0 to 65535 since 65536 is also a power of two. This means that for trainers with random fitness values, any one of the six fitness values determines the other five and generally their team selection. Also one of the two random values that are combined has two higher bits set to zero which means the initial value in the cycle lies between 0 and 16383 inclusive. But the next value is what is used as the first random fitness, so the first fitness isn’t forced to be low.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/pok%C3%A9mon-stadium-2/'>Pokémon Stadium 2</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=How+Pok%C3%A9mon+Stadium+2+utterly+fouls+up+team+selection+-+GMS+Ruins+Video+Games&url=%2Fposts%2Fps2-ai-teams%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=How+Pok%C3%A9mon+Stadium+2+utterly+fouls+up+team+selection+-+GMS+Ruins+Video+Games&u=%2Fposts%2Fps2-ai-teams%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=How+Pok%C3%A9mon+Stadium+2+utterly+fouls+up+team+selection+-+GMS+Ruins+Video+Games&url=%2Fposts%2Fps2-ai-teams%2F" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/challenge-cup/"><div class="card-body"> <em class="small" data-ts="1641731670" data-df="ll" > Jan 9, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Challenge Cup teams in Pokémon Stadium 2</h3><div class="text-muted small"><p> It’s been a while, hasn’t it? I did have plans for having my next post be on Dragon Ball Z: Budokai Tenkaichi 2, but then I decided that to do that as well as I wanted I would first have to do one ...</p></div></div></a></div><div class="card"> <a href="/posts/how-chopt-works/"><div class="card-body"> <em class="small" data-ts="1654539960" data-df="ll" > Jun 6, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>How CHOpt works</h3><div class="text-muted small"><p> When I made this blog I envisioned myself talking about how other people’s programs work. However, I’ve had plenty of people ask me how my own program CHOpt works, so today I’m going to talk about ...</p></div></div></a></div><div class="card"> <a href="/posts/ntr-friendship/"><div class="card-body"> <em class="small" data-ts="1626715922" data-df="ll" > Jul 19, 2021 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Friends in Yu-Gi-Oh! Nightmare Troubadour</h3><div class="text-muted small"><p> This is the third and final post I plan to do on Yu-Gi-Oh! Nightmare Troubadour. I may come back to it at a later date, but for now I’ve worked out everything I really wanted to know. Like the prev...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/challenge-cup/" class="btn btn-outline-primary" prompt="Older"><p>Challenge Cup teams in Pokémon Stadium 2</p></a> <a href="/posts/how-chopt-works/" class="btn btn-outline-primary" prompt="Newer"><p>How CHOpt works</p></a></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://github.com/GenericMadScientist">GenericMadScientist</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script data-goatcounter="https://gmsblog.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
